use leptos::prelude::*;

#[derive(Clone, Debug)]
pub struct Vulnerability {
    pub id: String,
    pub title: String,
    pub description: String,
    pub severity: String,
    pub status: String,
    pub asset_name: String,
    pub discovery_date: String,
}

#[component]
pub fn VulnerabilityCard(
    #[prop(into)] vulnerability: Vulnerability,
    #[prop(into, optional)] on_click: Option<Callback<String>>,
) -> impl IntoView {
    // Clone all the fields we'll need in closures
    let vuln_id = vulnerability.id.clone();
    let severity = vulnerability.severity.clone();
    let status = vulnerability.status.clone();
    let title = vulnerability.title.clone();
    let description = vulnerability.description.clone();
    let asset_name = vulnerability.asset_name.clone();
    let discovery_date = vulnerability.discovery_date.clone();

    let handle_click = move |_| {
        if let Some(callback) = on_click.as_ref() {
            callback.run(vuln_id.clone());
        }
    };

    // Create severity_class closure with freshly cloned severity value
    let severity_for_class = severity.clone();
    let severity_class = move || {
        format!(
            "severity-badge severity-{}",
            severity_for_class.to_lowercase()
        )
    };

    // Create status_class closure with freshly cloned status value
    let status_for_class = status.clone();
    let status_class = move || format!("status-badge status-{}", status_for_class.to_lowercase());

    view! {
        <div class="vulnerability-card" on:click={handle_click}>
            <div class="vulnerability-card-header">
                <span class={severity_class}>{move || severity.clone()}</span>
                <span class={status_class}>{move || status.clone()}</span>
            </div>
            <div class="vulnerability-card-body">
                <h3 class="vuln-title">{move || title.clone()}</h3>
                <p class="vuln-description">{move || description.clone()}</p>
                <div class="vulnerability-card-row">
                    <span class="label">"Asset:"</span>
                    <span class="value">{move || asset_name.clone()}</span>
                </div>
                <div class="vulnerability-card-row">
                    <span class="label">"Discovered:"</span>
                    <span class="value">{move || discovery_date.clone()}</span>
                </div>
            </div>
        </div>
    }
}
